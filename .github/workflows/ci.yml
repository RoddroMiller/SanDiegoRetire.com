name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  lint-and-build:
    name: Lint & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint
        continue-on-error: true

      - name: Build
        run: npm run build

  functions-validate:
    name: Functions Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: functions/package-lock.json

      - name: Install functions dependencies
        working-directory: functions
        run: npm ci

      - name: Syntax check
        working-directory: functions
        run: node --check index.js

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Audit root dependencies
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Install functions dependencies
        working-directory: functions
        run: npm ci

      - name: Audit functions dependencies
        working-directory: functions
        run: npm audit --audit-level=high
        continue-on-error: true

  firestore-rules-test:
    name: Firestore Rules Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install Java (required by Firebase Emulator)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Install dependencies
        run: npm ci

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Run Firestore rules tests
        run: firebase emulators:exec --only firestore "npx vitest run tests/firestore-rules.test.js" --project portfolio-architect-8b47d
